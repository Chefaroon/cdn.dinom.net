!function(t,n){function r(t,r){var e,a=t,i=!1,o=null;try{e="session"===r?sessionStorage:localStorage}catch(u){e=r}function f(t){return!t.toString().match(/[^a-z_0-9]/ig)}function l(t){throw Error(t)}function s(){try{return e.setItem(a,JSON.stringify(o)),!0}catch(t){return l(t),!1}}function c(t){return!!o.tables[t]}function d(t){if(!c(t))return l('Table "'+t+'" does not exist'),!1}function h(t){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function p(t){try{return o.tables[t].auto_increment=1,o.data[t]={},o.data[t]}catch(n){return l(n),!1}}function y(t,n,r){try{if(o.tables[t].fields=o.tables[t].fields.concat(n),void 0!==r){for(var e in o.data[t])if(o.data[t].hasOwnProperty(e))for(var a in n)"object"==typeof r?o.data[t][e][n[a]]=r[n[a]]:o.data[t][e][n[a]]=r}return!0}catch(i){return l(i),!1}}function v(t,n){try{return o.data[t][o.tables[t].auto_increment]=n,n._ID=o.tables[t].auto_increment,o.tables[t].auto_increment++,n._ID}catch(r){return l(r),!1}}function b(t){var n=[];for(var r in o.data[t])o.data[t].hasOwnProperty(r)&&n.push(r);return n}function $(t,n){var r="",e={};for(r in n)-1===o.tables[t].fields.indexOf(r)&&l("Invalid query parameter: "+r),e[r]=n[r];return e}function _(t,r){for(var e="",a={},i=0;i<o.tables[t].fields.length;i++)a[e=o.tables[t].fields[i]]=null===r[e]||n===r[e]?null:r[e];return delete a._ID,a}function m(t,n){return function(r,e){var a="string"==typeof r[t]?r[t].toLowerCase():r[t],i="string"==typeof e[t]?e[t].toLowerCase():e[t];return"DESC"===n?a===i?0:a<i?1:-1:a===i?0:a>i?1:-1}}function g(t,n){var r=[],e=!1,a=null;for(var i in o.data[t])if(o.data[t].hasOwnProperty(i)){for(var u in a=o.data[t][i],e=!0,n)if(n.hasOwnProperty(u)){if("string"==typeof n[u]){if(null===a[u]||a[u].toString().toLowerCase()!==n[u].toString().toLowerCase()){e=!1;break}}else if(a[u]!==n[u]){e=!1;break}}e&&r.push(i)}return r}function w(t,n){var r=[],e=null;for(var a in o.data[t])o.data[t].hasOwnProperty(a)&&!0===n(h(e=o.data[t][a]))&&r.push(a);return r}function O(t,n,r){for(var e="",a=0,i=0;i<n.length;i++){e=n[i];var u=r(h(o.data[t][e]));if(u){var f=o.data[t][e];for(var l in u)u.hasOwnProperty(l)&&(f[l]=u[l]);o.data[t][e]=$(t,f),a++}}return a}return(o=e[a])&&(o=JSON.parse(o))&&o.tables&&o.data||(f(t)?(o={tables:{},data:{}},s(),i=!0):l('Database name "'+t+'" cannot be used, it contains invalid characters')),{commit:function(){return s()},isNew:function(){return i},drop:function(){e.hasOwnProperty(a)&&delete e[a],o=null},getItem:function(t){return function t(n){try{if(e.hasOwnProperty(n))return e[n]}catch(r){return l(r),null}}(t)},replace:function(t){return function t(n,r){try{return e.setItem(n,r),!0}catch(a){return l(a),!1}}(a,t)},prepExport:function(){return JSON.stringify(o)},tableExists:function(t){return c(t)},tableFields:function(t){return function t(n){try{var r=o.tables[n].fields;return -1!==r.indexOf("_ID")&&r.splice(r.indexOf("_ID"),1),o.tables[n].fields}catch(e){return l(e),null}}(t)},tableCount:function(){return function t(){var n=0;for(var r in o.tables)o.tables.hasOwnProperty(r)&&n++;return n}()},columnExists:function(t,n){return function t(n,r){var e=!1,a=o.tables[n].fields;for(var i in a)if(a[i]===r){e=!0;break}return e}(t,n)},createTable:function(t,n){if(!f(t))return l('The table "'+t+'" cannot be created, it contains invalid characters.'),!1;if(this.tableExists(t))return l('Table name "'+t+'" already exists.'),!1;var r,e=!0;for(r=0;r<n.length;r++)if(!f(n[r])){e=!1;break}if(!e)return l("One or more field names in the table definition contains invalid characters"),!1;var a={};for(r=0;r<n.length;r++)a[n[r]]=!0;for(var i in delete a._ID,n=[],a)a.hasOwnProperty(i)&&n.push(i);return n.push("_ID"),function t(n,r){try{return o.tables[n]={fields:r,auto_increment:1},o.data[n]={},!0}catch(e){return l(e),!1}}(t,n)},createTableWithData:function(t,n){if("object"!=typeof n||!n.length||n.length<1)return l("Supplied data has to be an object. Example: [{k:v,k:v},{k:v,k:v}...]"),!1;var r=Object.keys(n[0]);if(this.createTable(t,r)){this.commit();for(var e=0;e<n.length;e++)v(t,n[e])||l("Failed to insert record: ["+JSON.stringify(n[e])+"]");this.commit()}return!0},dropTable:function(t){var n;d(t),n=t,delete o.tables[n],delete o.data[n]},empty:function(t){d(t),p(t)},alterTable:function(t,n,r){if(!f(t))return l('The table name "'+t+'" contains invalid characters'),!1;if("object"==typeof n){var e,a=!0;for(e=0;e<n.length;e++)if(!f(n[e])){a=!1;break}if(!a)return l("One or more field names in the table definition contains invalid characters"),!1;var i={};for(e=0;e<n.length;e++)i[n[e]]=!0;for(var o in delete i._ID,n=[],i)i.hasOwnProperty(o)&&n.push(o);return y(t,n,r)}if("string"==typeof n){if(!f(n))return l("One or more field names in the table definition contains invalid characters"),!1;var u=[];return u.push(n),y(t,u,r)}},rowCount:function(t){return d(t),function t(n){var r=0;for(var e in o.data[n])o.data[n].hasOwnProperty(e)&&r++;return r}(t)},insert:function(t,n){return d(t),v(t,_(t,n))},insertOrUpdate:function(t,n,r){d(t);var e=[];if(n?"object"==typeof n?e=g(t,$(t,n)):"function"==typeof n&&(e=w(t,n)):e=b(t),0===e.length)return v(t,_(t,r));var a=[];return O(t,e,function(t){return a.push(t._ID),r}),a},update:function(t,n,r){d(t);var e=[];return n?"object"==typeof n?e=g(t,$(t,n)):"function"==typeof n&&(e=w(t,n)):e=b(t),O(t,e,r)},query:function(t,r,e,a,i,u){d(t);var f=[];return r?"object"==typeof r?f=g(t,$(t,r),e,a):"function"==typeof r&&(f=w(t,r,e,a)):f=b(t,e,a),function t(r,e,a,i,u,f){var l,s=null,c=[],d=null;for(l=0;l<e.length;l++)s=e[l],d=o.data[r][s],c.push(h(d));if(u&&u instanceof Array)for(l=0;l<u.length;l++)c.sort(m(u[l][0],u[l].length>1?u[l][1]:null));if(f&&f instanceof Array){for(var p=0;p<f.length;p++){var y={},v=f[p];for(l=0;l<c.length;l++)n!==c[l]&&(c[l].hasOwnProperty(v)&&y.hasOwnProperty(c[l][v])?delete c[l]:y[c[l][v]]=1)}var b=[];for(l=0;l<c.length;l++)n!==c[l]&&b.push(c[l]);c=b}return i=i&&"number"==typeof i?i:null,(a=a&&"number"==typeof a?a:null)&&i?c=c.slice(a,a+i):a?c=c.slice(a):i&&(c=c.slice(a,i)),c}(t,f,a,e,i,u)},queryAll:function(t,n){return n?this.query(t,n.hasOwnProperty("query")?n.query:null,n.hasOwnProperty("limit")?n.limit:null,n.hasOwnProperty("start")?n.start:null,n.hasOwnProperty("sort")?n.sort:null,n.hasOwnProperty("distinct")?n.distinct:null):this.query(t)},deleteRows:function(t,n){d(t);var r=[];return n?("object"==typeof n?r=g(t,$(t,n)):"function"==typeof n&&(r=w(t,n)),function t(n,r){for(var e=0;e<r.length;e++)o.data[n].hasOwnProperty(r[e])&&delete o.data[n][r[e]];return r.length}(t,r)):p(t)},usedDB:a,storage:e}}"undefined"!=typeof module&&module.exports?module.exports=r:"function"==typeof define&&define.amd?define(function(){return r}):t.SaDB=r}("undefined"!=typeof window?window:this);