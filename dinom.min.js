!function(t,n){function r(t,r){var e,a=t,i=!1,o=null;try{e="session"===r?sessionStorage:localStorage}catch(u){e=r}function f(t){return!t.toString().match(/[^a-z_0-9]/ig)}function l(t){throw Error(t)}function s(){try{return e.setItem(a,JSON.stringify(o)),!0}catch(t){return l(t),!1}}function c(t){return!!o.tables[t]}function d(t){if(!c(t))return l('Table "'+t+'" does not exist'),!1}function h(t){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n}function p(t){try{return o.tables[t].auto_increment=1,o.data[t]={},o.data[t]}catch(n){return l(n),!1}}function y(t,n,r){try{if(o.tables[t].fields=o.tables[t].fields.concat(n),void 0!==r){for(var e in o.data[t])if(o.data[t].hasOwnProperty(e))for(var a in n)"object"==typeof r?o.data[t][e][n[a]]=r[n[a]]:o.data[t][e][n[a]]=r}return!0}catch(i){return l(i),!1}}function v(t,n){try{return o.data[t][o.tables[t].auto_increment]=n,n._ID=o.tables[t].auto_increment,o.tables[t].auto_increment++,n._ID}catch(r){return l(r),!1}}function b(t){var n=[];for(var r in o.data[t])o.data[t].hasOwnProperty(r)&&n.push(r);return n}function $(t,n){var r="",e={};for(r in n)-1===o.tables[t].fields.indexOf(r)&&l("Invalid query parameter: "+r),e[r]=n[r];return e}function _(t,r){for(var e="",a={},i=0;i<o.tables[t].fields.length;i++)a[e=o.tables[t].fields[i]]=null===r[e]||n===r[e]?null:r[e];return delete a._ID,a}function m(t,n){return function(r,e){var a="string"==typeof r[t]?r[t].toLowerCase():r[t],i="string"==typeof e[t]?e[t].toLowerCase():e[t];return"DESC"===n?a===i?0:a<i?1:-1:a===i?0:a>i?1:-1}}function g(t,n){var r=[],e=!1,a=null;for(var i in o.data[t])if(o.data[t].hasOwnProperty(i)){for(var u in a=o.data[t][i],e=!0,n)if(n.hasOwnProperty(u)){if("string"==typeof n[u]){if(null===a[u]||a[u].toString().toLowerCase()!==n[u].toString().toLowerCase()){e=!1;break}}else if(a[u]!==n[u]){e=!1;break}}e&&r.push(i)}return r}function w(t,n){var r=[],e=null;for(var a in o.data[t])o.data[t].hasOwnProperty(a)&&!0===n(h(e=o.data[t][a]))&&r.push(a);return r}function O(t,n,r){for(var e="",a=0,i=0;i<n.length;i++){e=n[i];var u=r(h(o.data[t][e]));if(u){var f=o.data[t][e];for(var l in u)u.hasOwnProperty(l)&&(f[l]=u[l]);o.data[t][e]=$(t,f),a++}}return a}return(o=e[a])&&(o=JSON.parse(o))&&o.tables&&o.data||(f(t)?(o={tables:{},data:{}},s(),i=!0):l('Database name "'+t+'" cannot be used, it contains invalid characters')),{commit:function(){return s()},isNew:function(){return i},drop:function(){e.hasOwnProperty(a)&&delete e[a],o=null},getItem:function(t){return function t(n){try{if(e.hasOwnProperty(n))return e[n]}catch(r){return l(r),null}}(t)},replace:function(t){return function t(n,r){try{return e.setItem(n,r),!0}catch(a){return l(a),!1}}(a,t)},prepExport:function(){return JSON.stringify(o)},tableExists:function(t){return c(t)},tableFields:function(t){return function t(n){try{var r=o.tables[n].fields;return -1!==r.indexOf("_ID")&&r.splice(r.indexOf("_ID"),1),o.tables[n].fields}catch(e){return l(e),null}}(t)},tableCount:function(){return function t(){var n=0;for(var r in o.tables)o.tables.hasOwnProperty(r)&&n++;return n}()},columnExists:function(t,n){return function t(n,r){var e=!1,a=o.tables[n].fields;for(var i in a)if(a[i]===r){e=!0;break}return e}(t,n)},createTable:function(t,n){if(!f(t))return l('The table "'+t+'" cannot be created, it contains invalid characters.'),!1;if(this.tableExists(t))return l('Table name "'+t+'" already exists.'),!1;var r,e=!0;for(r=0;r<n.length;r++)if(!f(n[r])){e=!1;break}if(!e)return l("One or more field names in the table definition contains invalid characters"),!1;var a={};for(r=0;r<n.length;r++)a[n[r]]=!0;for(var i in delete a._ID,n=[],a)a.hasOwnProperty(i)&&n.push(i);return n.push("_ID"),function t(n,r){try{return o.tables[n]={fields:r,auto_increment:1},o.data[n]={},!0}catch(e){return l(e),!1}}(t,n)},createTableWithData:function(t,n){if("object"!=typeof n||!n.length||n.length<1)return l("Supplied data has to be an object. Example: [{k:v,k:v},{k:v,k:v}...]"),!1;var r=Object.keys(n[0]);if(this.createTable(t,r)){this.commit();for(var e=0;e<n.length;e++)v(t,n[e])||l("Failed to insert record: ["+JSON.stringify(n[e])+"]");this.commit()}return!0},dropTable:function(t){var n;d(t),n=t,delete o.tables[n],delete o.data[n]},empty:function(t){d(t),p(t)},alterTable:function(t,n,r){if(!f(t))return l('The table name "'+t+'" contains invalid characters'),!1;if("object"==typeof n){var e,a=!0;for(e=0;e<n.length;e++)if(!f(n[e])){a=!1;break}if(!a)return l("One or more field names in the table definition contains invalid characters"),!1;var i={};for(e=0;e<n.length;e++)i[n[e]]=!0;for(var o in delete i._ID,n=[],i)i.hasOwnProperty(o)&&n.push(o);return y(t,n,r)}if("string"==typeof n){if(!f(n))return l("One or more field names in the table definition contains invalid characters"),!1;var u=[];return u.push(n),y(t,u,r)}},rowCount:function(t){return d(t),function t(n){var r=0;for(var e in o.data[n])o.data[n].hasOwnProperty(e)&&r++;return r}(t)},insert:function(t,n){return d(t),v(t,_(t,n))},insertOrUpdate:function(t,n,r){d(t);var e=[];if(n?"object"==typeof n?e=g(t,$(t,n)):"function"==typeof n&&(e=w(t,n)):e=b(t),0===e.length)return v(t,_(t,r));var a=[];return O(t,e,function(t){return a.push(t._ID),r}),a},update:function(t,n,r){d(t);var e=[];return n?"object"==typeof n?e=g(t,$(t,n)):"function"==typeof n&&(e=w(t,n)):e=b(t),O(t,e,r)},query:function(t,r,e,a,i,u){d(t);var f=[];return r?"object"==typeof r?f=g(t,$(t,r),e,a):"function"==typeof r&&(f=w(t,r,e,a)):f=b(t,e,a),function t(r,e,a,i,u,f){var l,s=null,c=[],d=null;for(l=0;l<e.length;l++)s=e[l],d=o.data[r][s],c.push(h(d));if(u&&u instanceof Array)for(l=0;l<u.length;l++)c.sort(m(u[l][0],u[l].length>1?u[l][1]:null));if(f&&f instanceof Array){for(var p=0;p<f.length;p++){var y={},v=f[p];for(l=0;l<c.length;l++)n!==c[l]&&(c[l].hasOwnProperty(v)&&y.hasOwnProperty(c[l][v])?delete c[l]:y[c[l][v]]=1)}var b=[];for(l=0;l<c.length;l++)n!==c[l]&&b.push(c[l]);c=b}return i=i&&"number"==typeof i?i:null,(a=a&&"number"==typeof a?a:null)&&i?c=c.slice(a,a+i):a?c=c.slice(a):i&&(c=c.slice(a,i)),c}(t,f,a,e,i,u)},queryAll:function(t,n){return n?this.query(t,n.hasOwnProperty("query")?n.query:null,n.hasOwnProperty("limit")?n.limit:null,n.hasOwnProperty("start")?n.start:null,n.hasOwnProperty("sort")?n.sort:null,n.hasOwnProperty("distinct")?n.distinct:null):this.query(t)},deleteRows:function(t,n){d(t);var r=[];return n?("object"==typeof n?r=g(t,$(t,n)):"function"==typeof n&&(r=w(t,n)),function t(n,r){for(var e=0;e<r.length;e++)o.data[n].hasOwnProperty(r[e])&&delete o.data[n][r[e]];return r.length}(t,r)):p(t)},usedDB:a,storage:e}}"undefined"!=typeof module&&module.exports?module.exports=r:"function"==typeof define&&define.amd?define(function(){return r}):t.SaDB=r}("undefined"!=typeof window?window:this);!function(e,t){function n(){var e=!1,t={DevDebug:!0,VerboseDebug:!0,WSMaxRequestWaitTime:5,RequestMonitorInterval:500,Reconnect:{MaxAttempts:5,AttemptInterval:3e3,tryConnectingEvery:30,MaxTries:6,lifesignsInterval:3},HandlerFunctions:{GlobalResponseError:function(e){o("Request resulted in an error:"),r(e)},GlobalRequestTimeout:function(t){o("Request has timed out:"+JSON.stringify(t),!0),f.Insert(e.DB.queueTableExpired,t)},Unreachable_WS_Server:function(){r("Connection to WebSocket server "+m.Server+" cannot be established successfully.")}},DB:{Name:"__DinomDB__",Engine:"local",queueTable:"_Dinom_Queue_",queueTableExpired:"_Dinom_Queue_Expired_"}},n=!1;function r(e){throw Error(e)}function o(t,n){return!("object"!=typeof e||!e.hasOwnProperty("DevDebug")||e.hasOwnProperty("VerboseDebug")&&!e.VerboseDebug&&n)&&!!e.DevDebug&&console.log(t)}function i(e,t){try{var n={};for(op in e=e||{},t)n[op]=void 0!==e[op]?e[op]:t[op];return n}catch(o){r(o)}}function a(t){try{for(var n in t)e[n]=t[n]}catch(o){r(o)}}function s(e,t){try{if(null!==n.storage.getItem(e)&&null==n.storage.getItem(t)&&e!==t)return n.storage.setItem(t,n.storage.getItem(e)),n.storage.removeItem(e),!0;return!1}catch(r){return!1}}function u(){return Math.round(new Date().getTime()/1e3)}var c={custom:{onOpen:!1,onMessage:!1,onError:!1,onClose:!1},onOpen:function(e){try{o("WebSocket connection opened!",!0);var t=document.cookie.split("; ").reduce(function(e,t,n){if(e.length>0){var r=t.split(/\s*(?:=)(.*)/gm);e[r[0].replace(/\s+/g,"")]=r[1].trim()}return e},{});if(o('Sending any defined Cookies as Handshake: "'+JSON.stringify(t)+'"',!0),m.Stream.send(JSON.stringify({Cmd:"Handshake",Data:t,QID:"-"})),0!==m.Reconnect_mon.interval&&(o("Clearing reconnect monitor interval ...",!0),clearInterval(m.Reconnect_mon.interval),m.Reconnect_mon.interval=0),m.serverAvailable=!1,"function"==typeof c.custom.onOpen)return o("Custom onOpen() function found, invoking it ...",!0),c.custom.onOpen(e)}catch(n){r(n)}},onMessage:function(e){try{if(o("Received message from stream:\n	"+e.data,!0),d.In(JSON.parse(e.data)),"function"==typeof c.custom.onMessage)return o("Custom onMessage() function found, invoking it ...",!0),c.custom.onMessage(e)}catch(t){if(c.custom.onError)return c.custom.onError(l);r(t)}},onError:function(e){if(o("WebSocket connection encountered an error:",!0),o(e,!0),0===m.Reconnect_mon.interval&&(o("Starting Reconnect from _ws_event.onError() ...",!0),m.Reconnect()),"function"==typeof c.custom.onError)return o("Custom onError() function found, invoking it ...",!0),c.custom.onError(e)},onClose:function(e){if(o("WebSocket connection was closed!",!0),0===m.Reconnect_mon.interval?(o("Starting Reconnect from _ws_event.onClose() ...",!0),m.Reconnect()):!0==m.serverAvailable&&(o("Resetting reconnect attemps counter",!0),m.Reconnect_mon.attempts=0),"function"==typeof c.custom.onClose)return o("Custom onClose() function found, invoking it ..."),c.custom.onClose(e)}},f={Save:function(){return n.commit()},Dump:function(){return n.prepExport()},TableCount:function(){return n.tableCount()},IsDBSet:function(){return!n.isNew()},Destroy:function(e,t){try{if(e||r("Di.DB.Destroy() invoked without specifying a database name."),t||confirm('Are you sure you want to destroy the database "'+e+'"?'))return n.storage.removeItem(e)}catch(o){r(o)}},CreateTable:function(e,t,o){try{e&&t||r("Di.DB.CreateTable() invoked without specifying a table name or array of columns."),n.createTable(e,t),o||this.Save()}catch(i){r(i)}},CreateTableWithData:function(e,t,o){try{e&&t||r("Di.DB.CreateTableWithData() invoked without specifying a table name or array of rows."),n.createTableWithData(e,t),o||this.Save()}catch(i){r(i)}},IsTable:function(e){return e||r("Di.DB.IsTable() invoked without specifying a table name."),n.tableExists(e)},Empty:function(e){try{return e||r("Di.DB.Empty() invoked without specifying a table name."),n.empty(e),this.Save()}catch(t){r(t)}},Drop:function(e){try{e||r("Di.DB.Drop() invoked without specifying a table name."),n.dropTable(e),this.Save()}catch(t){r(t)}},Export:function(e){try{return e||r("Di.DB.Export() invoked without specifying storage key name."),"_selfDB"===e&&(e=n.usedDB),n.getItem(e)}catch(t){r(t)}},CountRows:function(e){try{return e||r("Di.DB.CountRows() invoked without specifying table name."),n.rowCount(e)}catch(t){r(t)}},GetColumns:function(e){try{return e||r("Di.DB.GetColumns() invoked without specifying table name."),n.tableFields(e)}catch(t){r(t)}},CheckColumn:function(e,t){try{return e&&t||r("Di.DB.CheckColumn() invoked without specifying table name or column name."),n.columnExists(e,t)}catch(o){r(o)}},AlterTable:function(e,t,o){try{return e&&t||r("Di.DB.AlterTable() invoked without specifying table name or columns."),n.alterTable(e,t,o)}catch(i){r(i)}},Get:function(t,o,i,a,s,u){try{if(t||r("Di.DB.Get() invoked without specifying table name."),"function"!=typeof o){for(k in o)if("object"==typeof o[k])var c=function(e){if(o[k].includes(e[Object.keys(o)[0]]))return!0}}var f=n.queryAll(t,{query:c||o,sort:a,limit:s});if(void 0===i||!1==i)return f;var d=[];if(0===f.length)return d;for(entry in f){var m={};if("object"==typeof i)for(col in i)!f[entry].hasOwnProperty(i[col])&&e.DevDebug&&console.warn('Di.DB.Get() - Column selector "'+i[col]+'" does not exist in table "'+t+'".'),m[i[col]]=f[entry][i[col]];else!f[entry].hasOwnProperty(i)&&e.DevDebug&&console.warn('Di.DB.Get() - Column selector "'+i+'" does not exist in table "'+t+'".'),m[i]=f[entry][i];u&&(m._ID=f[entry]._ID),d.push(m)}return d}catch(h){r(h)}},LastID:function(e){try{return e||r("Di.DB.LastID() invoked without specifying table name."),JSON.parse(this.Export("_selfDB")).tables[e].auto_increment-1}catch(t){r(t)}},Insert:function(e,t,o,i){try{if(e&&t||r("Di.DB.Insert() invoked without specifying table name or entry data."),n.insert(e,t),i||this.Save(),o)return this.LastID(e)}catch(a){r(a)}},Update:function(e,t,o){try{e||r("Di.DB.Update() invoked without specifying table name."),t||r("Di.DB.Update() invoked without mandatory data selector."),o||r("Di.DB.Update() invoked without arguments for new field data."),n.update(e,t,function(e){for(var t in o)e[t]=o[t];return e}),this.Save()}catch(i){r(i)}},InsertORUpdate:function(e,t,o){try{e||r("Di.DB.InsertORUpdate() invoked without specifying table name."),t||r("Di.DB.InsertORUpdate() invoked without mandatory data selector."),o||r("Di.DB.InsertORUpdate() invoked without arguments for new entry."),n.insertOrUpdate(e,t,o),this.Save()}catch(i){r(i)}},Delete:function(e,t){try{if(e||r("Di.DB.Delete() invoked without specifying table name."),t||r("Di.DB.Delete() invoked without mandatory data selector."),"object"==typeof t[Object.keys(t)])for(k in t[Object.keys(t)[0]]){var o={};o[Object.keys(t)[0]]=t[Object.keys(t)[0]][k],n.deleteRows(e,o)}else n.deleteRows(e,t);this.Save()}catch(i){r(i)}},Extract:function(e,t,n,o,i){try{e||r("Di.DB.Extract() invoked without specifying table name."),t||r("Di.DB.Extract() invoked without mandatory data selector.");var a=this.Get(e,t,n,o,i,!0);if(!Array.isArray(a)||!a.length)return null;var s=[];for(entry in a)s.push(a[entry]._ID),delete a[entry]._ID;return this.Delete(e,{_ID:s}),a}catch(u){r(u)}},GetDBSize:function(e,t){var r="",o={},i="Database(s):\n";if(e)n.storage.hasOwnProperty(e)&&(r=n.storage[e],size=(16*n.storage[e].length/8192).toFixed(2),i+="	"+e+" = "+size+" KB\n",o[e]=parseFloat(size));else for(var a in n.storage)n.storage.hasOwnProperty(a)&&(r+=n.storage[a],size=(16*n.storage[a].length/8192).toFixed(2),i+="	"+a+" = "+size+" KB\n",o[a]=parseFloat(size));var s=parseFloat(r?(16*r.length/8192).toFixed(2):0),u=parseFloat(r?2048-(16*r.length/8192).toFixed(2):"2048");return i+=(r?"\nTotal usage= "+s+" KB":"None (0 KB)")+"\n"+(r?"Space remaining= ~"+u+" KB":"2 MB"),o.total=s,o.remaining=u,t&&console.log(i),o}},d={In:function(t){try{if(o("Q.In() invoked with:\n	"+JSON.stringify(t),!0),"object"!=typeof t)throw Error("Messaged received from server could not be processed");if(!t.hasOwnProperty("status"))throw e.HandlerFunctions.GlobalResponseError(t),Error("Received message from server without mandatory Status, GlobalReponseError() was invoked.");if("[...]"==t.status&&t.hasOwnProperty("QID"))return this.__in.Request_Process(t);if("ssr"==t.status&&t.hasOwnProperty("data")&&"object"==typeof t.data&&t.data.hasOwnProperty("call")&&"string"==typeof t.data.call)return this.__in.ServerSideRequest(t);if((rStatus="int"==typeof t.status&&t.status)>1e3&&e.DevDebug&&(console.warn("Received unexpected Status "+rStatus+"."),console.log(t)),500===rStatus&&console.error("Server returned an error:\n	"+(t.hasOwnProperty("data")?t.data:"")),t.hasOwnProperty("QID")&&"-"!==t.QID){if(o("Processing response for QID "+t.QID,!0),clearInterval(m.RequestMonitor[t.QID]),delete m.RequestMonitor[t.QID],dbRequest=(dbRequest=f.Extract(e.DB.queueTable,{_ID:t.QID},!1,[["_ID","ASC"]],1))&&dbRequest.hasOwnProperty(0)?dbRequest[0]:null)return this.__in.SuccessResponse(dbRequest,t);return this.__in.UnknownQID(t)}}catch(n){r(n)}},__in:{Request_Process:function(t){var n=f.Get(e.DB.queueTable,{_ID:t.QID},!1,[["_ID","ASC"]],1);if(!(n=n&&n.hasOwnProperty(0)?n[0]:null)){console.warn("Received Progress message for Timed out request with QID "+t.QID),o(t,!0);return}o("Received Progress message for QID "+t.QID+", extending timeout by "+e.WSMaxRequestWaitTime+" seconds",!0),f.Update(e.DB.queueTable,{_ID:t.QID},{sentAt:u()})},SSR:function(e){var t=e.data.call.split("."),n=p.SSR;try{for(var r=0;r<t.length;r++){if(!n.hasOwnProperty(t[r]))throw Error();n=n[t[r]]}if("function"!=typeof n)throw Error();return n(e.data.params)}catch(o){throw Error("Received ServerSideRequest for invalid function: "+e.data.call)}},SuccessResponse:function(t,n){if(n.hasOwnProperty("status")&&200==n.status){if(t.hasOwnProperty("onSuccess")){if("function"==typeof t.onSuccess)return t.onSuccess(n.data);if("function"==typeof window[t.onSuccess])return window[t.onSuccess](n.data);r("--------------Error--------------\nA request is set to trigger an undefined function for onSuccess.\n\nRequest: "+t.request+"\nSent at: "+t.sentAt+"\nonSuccess: "+t.onSuccess+"\nonError: "+t.onError+"\nonTimeout: "+t.onTimeout+"\n---------------------------------")}}else if(""!==t.onError){if("function"==typeof t.onError)return t.onError(n.data);if("function"==typeof window[t.onError])return window[t.onError](n.data);r("--------------Error--------------\nA request is set to trigger an undefined function for onError.\n\nRequest: "+t.request+"\nSent at: "+t.sentAt+"\nonSuccess: "+t.onSuccess+"\nonError: "+t.onError+"\nonTimeout: "+t.onTimeout+"\n---------------------------------")}else e.HandlerFunctions.GlobalResponseError(n.data)},UnknownQID:function(t){var n=f.Get(e.DB.queueTableExpired,{_ID:t.QID},!1,[["_ID","ASC"]],1);(n=n&&n.hasOwnProperty(0)?n[0]:null)&&r("\n--------------LATE RESPONSE--------------\n	! Received messaged for timed out request !\n\nQID: "+t.QID+"\nRequest: "+n.request+"\nSent at: "+n.sentAt+"\nTimeout: "+e.WSMaxRequestWaitTime+" seconds\nReceived at: "+u()+"\nTotal request time: "+(u()-n.sentAt)+" seconds\nData: "+(t.hasOwnProperty("data")?JSON.stringify(t.data):'""')+"\n-----------------------------------------\n"),r("\n--------------Warning--------------\nMessage received for unknown QID.\n\nStatus: "+t.status+"\nQID: "+t.QID+"\nReceived at: "+u()+"\nData: "+JSON.stringify(t.data)+"\n-----------------------------------")}},Out:function(t){if(!t||"object"!=typeof t||!t.hasOwnProperty("request")||!t.request||!t.hasOwnProperty("onSuccess")||!t.onSuccess)return r("Di.Q.Out() was called with missing required params {request, data, onSuccess}");try{if(request={Cmd:(t=i(t,{request:t.hasOwnProperty("request")?t.request:"",data:t.hasOwnProperty("data")?t.data:"",onSuccess:t.hasOwnProperty("onSuccess")?t.onSuccess:"",onError:t.hasOwnProperty("onError")?t.onError:"",onTimeout:t.hasOwnProperty("onTimeout")?t.onTimeout:""})).request,Data:t.data,onError:t.onError,onTimeout:t.onTimeout,sentAt:u(),QID:f.Insert(e.DB.queueTable,{sentAt:u(),request:t.request,onSuccess:t.onSuccess,onError:t.onError,onTimeout:t.onTimeout},!0)},"WS"==p.Proto.Main&&m.isConnected())return m.Stream.send(JSON.stringify(request)),d.Monitor(request),request.QID;if(("HTTP"==p.Proto.Main||"HTTP"==p.Proto.Backup)&&h.Server)return h.Send(request);throw Error("WebSocket server is unavailable and Backup HTTP server is not configured.")}catch(n){r("The WebSocket request was not sent due to an error:\n"+n)}},Monitor:function(t){try{if("object"!=typeof t||!t.hasOwnProperty("QID")||!t.QID)return r("Q.Monitor() called with invalid parameter.");m.RequestMonitor[t.QID]=setInterval(function(){var n=f.Get(e.DB.queueTable,{_ID:t.QID},"sentAt",null,1,!0)[0].sentAt;if(u()>parseInt(n)+parseInt(e.WSMaxRequestWaitTime)&&(clearInterval(m.RequestMonitor[t.QID]),dbRequest=f.Extract(e.DB.queueTable,{_ID:t.QID},!1,[["ID","ASC"]],1)[0],e.HandlerFunctions.GlobalRequestTimeout(dbRequest),dbRequest.hasOwnProperty("onTimeout")&&""!==dbRequest.onTimeout)){if("function"==typeof dbRequest.onTimeout)return dbRequest.onTimeout(dbRequest);if("function"==typeof window[dbRequest.onTimeout])return window[dbRequest.onTimeout](dbRequest);r("\n--------------Error--------------\nA request is set to trigger an undefined function for onTimeout.\n\nRequest: "+dbRequest.request+"\nSent at: "+dbRequest.sentAt+"\nonSuccess: "+dbRequest.onSuccess+"\nonError: "+dbRequest.onError+"\nonTimeout: "+dbRequest.onTimeout+"\n---------------------------------")}},e.RequestMonitorInterval)}catch(n){r(n)}},PrepareQueueTable:function(){try{f.IsTable(e.DB.queueTable)&&f.Drop(e.DB.queueTable),f.IsTable(e.DB.queueTableExpired)&&f.Drop(e.DB.queueTableExpired),queueTableContent=["request","sentAt","onSuccess","onError","onTimeout"],f.CreateTable(e.DB.queueTable,queueTableContent),f.CreateTable(e.DB.queueTableExpired,queueTableContent)}catch(t){r(t)}}},m={Server:!1,Stream:!1,serverAvailable:!1,Reconnect_mon:{interval:0,attempts:0},RequestMonitor:{},setHandler:function(e,t){try{switch(e&&t||r("Di.WS.setHandler() invoked without mandatory arguments for event and function."),"function"!=typeof t&&r("Di.WS.setHandler() invoked with invalid function argument."),e.toLowerCase()){case"open":case"onopen":return c.custom.onOpen=t;case"message":case"onmessage":return c.custom.onMessage=t;case"error":case"onerror":return c.custom.onError=t;case"close":case"onclose":return c.custom.onClose=t;default:r('Di.WS.setHandler() invoked with invalid event name "'+e+'". Expected [open, message, error, close]')}}catch(n){r(n)}},isConnected:function(){try{if("object"==typeof m.Stream&&1===m.Stream.readyState)return!0;return!1}catch(e){r(e)}},Connect:function(e){try{var t;return e||("string"!=typeof m.Server&&r("Di.WS.Connect() invoked without mandatory server argument."),e=this.Server),e=(t=e).startsWith("ws://")||t.startsWith("wss://")?t:"wss://"+t,o("Attempting to connect to "+e,!0),this.Server=e,this.Stream=new WebSocket(e),this.Stream.onopen=function(e){return c.onOpen(e)},this.Stream.onmessage=function(e){return c.onMessage(e)},this.Stream.onerror=function(e){return c.onError(e)},this.Stream.onclose=function(e){return c.onClose(e)},!0}catch(n){r(n)}},Reconnect:function(){this.Reconnect_mon.interval=setInterval(function(){m.Reconnect_mon.attempts++,m.Reconnect_mon.attempts===e.Reconnect.MaxAttempts&&(o("Maximum reconnection attempts reached!\nWill try reconnecting again in "+e.Reconnect.tryConnectingEvery+" seconds, for a total of "+e.Reconnect.MaxTries+" attempts.",!0),clearInterval(m.Reconnect_mon.interval),setTimeout(function(){m.Reconnect_mon.attempts=0,m.Reconnect_mon.interval=setInterval(function(){m.Reconnect_mon.attempts++,m.Reconnect_mon.attempts===e.Reconnect.MaxTries&&(o("Connection to the server is still not possible. Maximum tries reached!\nFrom this point on, we will just check if the server is available once every "+e.Reconnect.lifesignsInterval+" minutes",!0),clearInterval(m.Reconnect_mon.interval),setTimeout(function(){m.Reconnect_mon.attempts=0,m.Reconnect_mon.interval=setInterval(function(){m.Reconnect_mon.attempts++,o("Attempting to reconnect to "+m.Server+". Attempt N"+m.Reconnect_mon.attempts,!0),m.Connect(m.Server)},6e4*e.Reconnect.lifesignsInterval)},6e4*e.Reconnect.lifesignsInterval),e.HandlerFunctions.Unreachable_WS_Server()),o("Attempting to reconnect to "+m.Server+". Attempt N"+m.Reconnect_mon.attempts,!0),m.Connect(m.Server)},1e3*e.Reconnect.tryConnectingEvery)},1e3*e.Reconnect.tryConnectingEvery),e.HandlerFunctions.Unreachable_WS_Server()),o("Attempting to reconnect to "+m.Server+". Attempt N"+m.Reconnect_mon.attempts,!0),m.Connect(m.Server)},e.Reconnect.AttemptInterval)}},h={Server:!1,Handler:!1,Send:function(t){o("Di.XHR.Send() invoked!",!0),this.Server&&/^(https?:)\/\//.test(this.Server)||r('Invalid HTTP API server defined "'+this.Server+'". Please check your settings.'),this.Handler=new XMLHttpRequest,this.Handler.open("POST",new URL(t.Cmd,this.Server).href,!0),this.Handler.setRequestHeader("Content-Type","application/json"),this.Handler.setRequestHeader("REQUEST_QID",t.QID),o("Sending XHR request to "+this.Server,!0),this.Handler.onload=function(){return(o("XHR request completed",!0),200===this.status)?(o("XHR Request was successful: Status 200 OK",!0),o("XHR Response from web server: \n\n"+this.responseText,!0),d.In(JSON.parse(this.responseText))):(o("Request failed: Status "+this.status,!0),t.hasOwnProperty("onError"))?t.onError(this):void e.HandlerFunctions.GlobalResponseError(this)},this.Handler.onerror=function(){if(o("XHR request failed",!0),o(this,!0),t.hasOwnProperty("onError"))return t.onError(this);e.HandlerFunctions.GlobalResponseError(this)},this.Handler.onTimeout=function(){if(o("XHR request timed out",!0),t.hasOwnProperty("onTimeout"))return t.onTimeout(this);e.HandlerFunctions.GlobalRequestTimeout(this)},t.Data?(o("Sending POST request with data: "+JSON.stringify(t.Data),!0),this.Handler.send(JSON.stringify(t.Data))):(o("Sending POST without data.",!0),this.Handler.send())}},p={Proto:{Main:!1,Backup:!1},init:function(a){try{if(o("Di.API.init() invoked with settings: "+JSON.stringify(a),!0),"object"!=typeof a&&r("Di.API.init() requires object settings passed as parameter."),a.hasOwnProperty("Server")||r("Di.API.init() invoked without mandatory Server argument."),a.Server.hasOwnProperty("WS")||a.Server.hasOwnProperty("HTTP")||r("Di.API.init() requires either Server.WS, Server.HTTP, or both."),e=i(a.hasOwnProperty("Pref")?a.Pref:{},t),n=function t(){try{return"undefined"==typeof SaDB&&r("SaDB is not available."),SaDB(e.DB.Name,e.DB.Engine)}catch(n){r(n)}}(),d.PrepareQueueTable(),a.Server.WS&&(testResult=!(testConnection=!a.hasOwnProperty("autoConnect")||a.autoConnect)||m.Connect(a.Server.WS))&&(p.Proto.Main="WS",m.Server=a.Server.WS,a.Server.HTTP&&(p.Proto.Backup="HTTP",h.Server=a.Server.HTTP)),!a.Server.WS&&a.Server.HTTP&&(p.Proto.Main="HTTP",h.Server=a.Server.HTTP),"WS"==p.Proto.Main&&a.hasOwnProperty("onReady")&&"function"==typeof a.onReady){var s=function(e){a.onReady(),m.Stream.removeEventListener("open",s)};return m.Stream.addEventListener("open",s),!0}if("HTTP"==p.Proto.Main&&h.Server)return a.hasOwnProperty("onReady")&&"function"==typeof a.onReady&&a.onReady(),!0;return o("API.init() failed due to logical error. This should not happen."),!1}catch(u){return r(u),!1}},Call:function(e,t,n){try{o("Di.API.Call() invoked with:\n	Endpoint: "+e+"\n	Data: "+JSON.stringify(t)+"\n	Events: \n					"+Object.keys(n).map(function(e){return e+": "+n[e].toString()}).join(",\n\n					"),!0),e||r("Di.API.Call() invoked without mandatory endPoint argument."),n||r("Di.API.Call() invoked without mandatory events argument."),n=i(n,{success:!!n.hasOwnProperty("success")&&n.success,error:!!n.hasOwnProperty("error")&&n.error,timeout:!!n.hasOwnProperty("timeout")&&n.timeout});var a={request:e,onSuccess:n.success,onError:n.error,onTimeout:n.timeout};return t&&(a.data=t),d.Out(a)}catch(s){r(s)}},SSR:{}};return{TimeNow:function(){return u()},unsetArrayKey:function(e,t){return e.splice(0==t?1:t,1)},log:o,Cookie:{Set:function(e,t,n){return function e(t,n,i){try{t||r("Di.Cookie.Set() invoked without specifying a name.");var a="";if(i){var s=new Date;s.setTime(s.getTime()+864e5*i),a="; expires="+s.toUTCString()}return document.cookie=t+"="+(n||"")+a+"; path=/;",o('Cookie "'+t+'" set to "'+(n||"")+'"',!0),!0}catch(u){r(u)}}(e,t,n)},Get:function(e){return function e(t){try{for(var n=t+"=",o=document.cookie.split(";"),i=0;i<o.length;i++){for(var a=o[i];" "==a.charAt(0);)a=a.substring(1,a.length);if(0==a.indexOf(n))return a.substring(n.length,a.length)}return null}catch(s){r(s)}}(e)},Del:function(e){return function e(t){try{return document.cookie=t+"=; Max-Age=-99999999; path=/",o('Cookie "'+t+'" deleted',!0),!0}catch(n){r(n)}}(e)}},DB:f,Q:d,WS:m,XHR:h,API:p}}"undefined"!=typeof module&&module.exports?module.exports=n:"function"==typeof define&&define.amd?define(function(){return n}):e.Di=new n}("undefined"!=typeof window?window:this);